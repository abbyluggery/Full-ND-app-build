/**
 * Service class for integrating with Anthropic's Claude API
 * Handles all HTTP communication with Claude and manages API authentication
 */
public with sharing class ClaudeAPIService {

    // Constants for Claude API configuration
    private static final String API_VERSION = '2023-06-01';
    private static final String MODEL = 'claude-3-haiku-20240307';
    private static final Integer MAX_TOKENS = 4000;
    private static final Integer TIMEOUT_MS = 60000;
    private static final String API_ENDPOINT = 'https://api.anthropic.com/v1/messages';
    private static final String API_KEY = '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';

    /**
     * Main method to call Claude API with a job posting for analysis
     */
    public static ClaudeResponse analyzeJobPosting(Job_Posting__c jobPosting, String systemContext) {
        try {
            // Build the request JSON manually
            String requestBody = buildRequestJson(systemContext, jobPosting);

            // Make the HTTP callout
            HttpResponse response = sendRequest(requestBody);

            // Parse and return the response
            return parseResponse(response);

        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'Claude API Error: ' + e.getMessage());
            throw new ClaudeAPIException('Failed to analyze job posting: ' + e.getMessage(), e);
        }
    }

    /**
     * Builds the JSON request body manually
     */
    private static String buildRequestJson(String systemContext, Job_Posting__c jobPosting) {
        // Build the user prompt
        String userPrompt = buildJobAnalysisPrompt(jobPosting);

        // Use JSONGenerator to build proper JSON
        JSONGenerator gen = JSON.createGenerator(true);
        gen.writeStartObject();

        // Write top-level fields
        gen.writeStringField('model', MODEL);
        gen.writeNumberField('max_tokens', MAX_TOKENS);
        gen.writeStringField('system', systemContext);

        // Write messages array
        gen.writeFieldName('messages');
        gen.writeStartArray();
        gen.writeStartObject();
        gen.writeStringField('role', 'user');
        gen.writeStringField('content', userPrompt);
        gen.writeEndObject();
        gen.writeEndArray();

        gen.writeEndObject();
        return gen.getAsString();
    }

    /**
     * Constructs the prompt for Claude to analyze a job posting
     */
    private static String buildJobAnalysisPrompt(Job_Posting__c jobPosting) {
        String prompt = 'Analyze this job posting using the holistic decision framework:\n\n';

        prompt += '**Job Details:**\n';
        prompt += 'Title: ' + jobPosting.Title__c + '\n';
        prompt += 'Company: ' + jobPosting.Company__c + '\n';
        prompt += 'Location: ' + jobPosting.Location__c + '\n';
        prompt += 'Workplace Type: ' + jobPosting.Workplace_Type__c + '\n';
        prompt += 'Remote Policy: ' + jobPosting.Remote_Policy__c + '\n';

        if (jobPosting.Salary_Min__c != null || jobPosting.Salary_Max__c != null) {
            prompt += 'Salary Range: ';
            if (jobPosting.Salary_Min__c != null) prompt += '$' + jobPosting.Salary_Min__c;
            if (jobPosting.Salary_Min__c != null && jobPosting.Salary_Max__c != null) prompt += ' - ';
            if (jobPosting.Salary_Max__c != null) prompt += '$' + jobPosting.Salary_Max__c;
            prompt += '\n';
        }

        if (String.isNotBlank(jobPosting.Description__c)) {
            prompt += '\n**Description:**\n' + jobPosting.Description__c + '\n';
        }

        prompt += '\n**Analysis Required:**\n';
        prompt += '1. **Fit Score** (0-10): Calculate based on:\n';
        prompt += '   - MUST HAVES: Remote work, ND-friendly culture, Salary â‰¥ $85K, Flexible schedule\n';
        prompt += '   - NICE TO HAVES: Agentforce/AI focus (+2), Growth stage (+1), ND accommodations (+2), Career progression (+1)\n';
        prompt += '2. **ND Friendliness Score** (0-10): Assess neurodivergent-friendly culture indicators\n';
        prompt += '3. **Green Flags**: List positive indicators (bulleted list)\n';
        prompt += '4. **Red Flags**: List concerns or deal-breakers (bulleted list)\n';
        prompt += '5. **Recommendation**: HIGH PRIORITY / GOOD FIT / SKIP with reasoning\n';
        prompt += '\n**Output Format (JSON):**\n';
        prompt += '```json\n';
        prompt += '{\n';
        prompt += '  "fit_score": 8.5,\n';
        prompt += '  "nd_friendliness_score": 7,\n';
        prompt += '  "green_flags": ["Remote work", "Flexible hours", "Agentforce focus"],\n';
        prompt += '  "red_flags": ["Early meetings mentioned"],\n';
        prompt += '  "recommendation": "HIGH PRIORITY",\n';
        prompt += '  "reasoning": "Detailed explanation..."\n';
        prompt += '}\n';
        prompt += '```';

        return prompt;
    }

    /**
     * Sends the HTTP request to Claude API
     */
    private static HttpResponse sendRequest(String requestBody) {
        HttpRequest httpReq = new HttpRequest();
        httpReq.setEndpoint(API_ENDPOINT);
        httpReq.setMethod('POST');
        httpReq.setTimeout(TIMEOUT_MS);

        // Set headers
        httpReq.setHeader('Content-Type', 'application/json');
        httpReq.setHeader('anthropic-version', API_VERSION);
        httpReq.setHeader('x-api-key', API_KEY);

        // Set body
        httpReq.setBody(requestBody);

        // Log request for debugging
        System.debug(LoggingLevel.DEBUG, 'Claude API Request: ' + requestBody);

        // Send the request
        Http http = new Http();
        HttpResponse response = http.send(httpReq);

        // Log response status
        System.debug(LoggingLevel.DEBUG, 'Claude API Response Status: ' + response.getStatusCode());

        // Check for errors
        if (response.getStatusCode() != 200) {
            String errorMsg = 'Claude API returned status ' + response.getStatusCode() + ': ' + response.getBody();
            throw new ClaudeAPIException(errorMsg);
        }

        return response;
    }

    /**
     * Parses the JSON response from Claude API
     */
    private static ClaudeResponse parseResponse(HttpResponse response) {
        String responseBody = response.getBody();
        System.debug(LoggingLevel.DEBUG, 'Claude API Response Body: ' + responseBody);

        try {
            ClaudeResponse claudeResp = (ClaudeResponse) JSON.deserialize(
                responseBody,
                ClaudeResponse.class
            );
            return claudeResp;
        } catch (Exception e) {
            throw new ClaudeAPIException('Failed to parse Claude response: ' + e.getMessage(), e);
        }
    }

    /**
     * Extracts just the text content from Claude's response
     */
    public static String extractTextContent(ClaudeResponse response) {
        if (response.content != null && !response.content.isEmpty()) {
            for (Content c : response.content) {
                if (c.type == 'text' && String.isNotBlank(c.text)) {
                    return c.text;
                }
            }
        }
        return '';
    }

    /**
     * Response wrapper classes
     */
    public class ClaudeResponse {
        public String id;
        public String type;
        public String role;
        public List<Content> content;
        public String model;
        public String stop_reason;
        public Usage usage;
    }

    public class Content {
        public String type;
        public String text;
    }

    public class Usage {
        public Integer input_tokens;
        public Integer output_tokens;
    }

    /**
     * Custom exception class
     */
    public class ClaudeAPIException extends Exception {}
}
